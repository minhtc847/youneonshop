'use client'
import React, { useEffect, useState } from 'react';
import { getCartItems, CartItem } from '@/service/cartServices';
import locationData from '@/data/location.json';
import { useSession } from "next-auth/react";
import {motion} from "framer-motion";
import Image from "next/image";
import {useRouter} from "next/navigation";
import {toast} from "react-toastify";


interface Address {
    city: string;
    district: string;
    ward: string;
    detail: string;
    telephone: string;
    description: string;
}

export default function CheckoutPage () {
    const router = useRouter()
    const [cartItems, setCartItems] = useState<CartItem[]>([]);
    const [totalPrice, setTotalPrice] = useState(0);
    const [address, setAddress] = useState<Address>({
        city: '',
        district: '',
        ward: '',
        detail: '',
        telephone: '',
        description: ''
    });
    const [imageLoadError, setImageLoadError] = useState<Record<string, boolean>>({})
    const { data: session,status } = useSession();
    const getImageSrc = (item: CartItem) => {
        if (imageLoadError[item.product_id]) {
            return "/placeholder.svg"
        }
        return item.image || "/placeholder.svg"
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
    const fetchCartItems = async () => {
        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
// @ts-ignore
        const token = session?.user?.authentication_token;
        const items = await getCartItems(token);
        return items.cart;

    };
    useEffect(() => {
        fetchCartItems().then(r => {
            setCartItems(r);
            const total = r.reduce((sum, item) => sum + item.price * item.quantity, 0);
            setTotalPrice(total);
        });

    },[status, session, router, fetchCartItems]);

    const handleAddressChange = (e: React.ChangeEvent<HTMLSelectElement | HTMLInputElement | HTMLTextAreaElement>) => {
        const { name, value } = e.target;
        setAddress({ ...address, [name]: value });
    };

    const handleImageError = (itemId: string) => {
        setImageLoadError((prev) => ({ ...prev, [itemId]: true }))
    }
    const validateAddress = () => {
        // Kiểm tra tất cả các trường có bị trống không
        if (!address.city.trim()) {
            toast.info("Vui lòng chọn Tinh/Thành Phố.");
            return false;
        }
        if (!address.district.trim()) {
            toast.info("Vui lòng chọn Huyen/Quan.");
            return false;
        }
        if (!address.ward.trim()) {
            toast.info("Vui lòng chọn Phường/Xã.");
            return false;
        }
        if (!address.detail.trim()) {
            toast.info("Vui lòng nhập Số Nhà.");
            return false;
        }
        if (!address.telephone.trim()) {
            toast.info("Vui lòng nhập Số Điện Thoại.");
            return false;
        }

        // Kiểm tra số điện thoại có đúng định dạng không (chỉ chứa số và có 10-11 chữ số)
        const phoneRegex = /^[0-9]{10,11}$/;
        if (!phoneRegex.test(address.telephone)) {
            toast.info("Số điện thoại không hợp lệ. Vui lòng nhập 10-11 chữ số.");
            return false;
        }

        return true;
    };


    const handleCheckout = () => {
        if (!validateAddress()) return;

        router.push("/payment?total=" + totalPrice + "&address=" + JSON.stringify(address));
    };

    return (
        <main className="container mx-auto px-4 py-16">
            <div className="flex flex-col md:flex-row gap-8 mb-16 checkout-page">
                <div className="address-form bg-gray-800 p-8 rounded-lg shadow-md mb-6 md:w-2/3">
                    <h2 className="text-2xl font-bold mb-4 text-neon-blue">Thông tin thanh toán</h2>
                    <div className="mb-4">
                        <label className="block text-neon-pink mb-2">Thành Phố/Tỉnh</label>
                        <select name="city" value={address.city} onChange={handleAddressChange}
                                className="w-full p-2 rounded">
                            <option value="">Select City</option> {/* Add an empty option */}
                            {locationData.map((city) => (
                                <option key={city.Code} value={city.Code}>{city.FullName}</option>
                            ))}
                        </select>
                    </div>
                    <div className="mb-4">
                        <label className="block text-neon-pink mb-2">Quận/Huyện</label>
                        <select name="district" value={address.district} onChange={handleAddressChange}
                                className="w-full p-2 rounded">
                            <option value="">Select District</option> {/* Add an empty option */}
                            {locationData.find(city => city.Code === address.city)?.District.map((district) => (
                                <option key={district.Code} value={district.Code}>{district.FullName}</option>
                            ))}
                        </select>
                    </div>
                    <div className="mb-4">
                        <label className="block text-neon-pink mb-2">Phường/Xã</label>
                        <select name="ward" value={address.ward} onChange={handleAddressChange}
                                className="w-full p-2 rounded">
                            <option value="">Select Ward</option> {/* Add an empty option */}
                            {locationData.find(city => city.Code === address.city)?.District.find(district => district.Code === address.district)?.Ward.map((ward) => (
                                <option key={ward.Code} value={ward.Code}>{ward.FullName}</option>
                            ))}
                        </select>
                    </div>
                    <div className="mb-4">
                        <label className="block text-neon-pink mb-2">Số Nhà</label>
                        <input type="text" name="detail" value={address.detail} onChange={handleAddressChange}
                               className="w-full p-2 rounded"/>
                    </div>
                    <div className="mb-4">
                        <label className="block text-neon-pink mb-2">Điện Thoại</label>
                        <input type="text" name="telephone" value={address.telephone} onChange={handleAddressChange}
                               className="w-full p-2 rounded"/>
                    </div>
                    <div className="mb-4">
                        <label className="block text-neon-pink mb-2">Ghi chú</label>
                        <textarea name="description" value={address.description} onChange={handleAddressChange}
                                  className="w-full p-2 rounded"></textarea>
                    </div>
                    <button onClick={handleCheckout}
                            className="bg-neon-blue hover:bg-neon-blue/80 text-black font-semibold py-2 px-4 rounded-full transition-all duration-300 hover:shadow-neon-glow">Thanh toan
                    </button>
                </div>
                <div className="checkout-summary bg-gray-800 p-6 rounded-lg shadow-md md:w-1/3 ">
                    {cartItems.length === 0 ? (
                        <motion.div
                            className="text-center space-y-6"
                            initial={{opacity: 0}}
                            animate={{opacity: 1}}
                            transition={{duration: 0.5, delay: 0.2}}
                        >
                            <p className="text-xl text-gray-400">Your cart is empty. Start shopping to add items to your
                                cart!</p>
                        </motion.div>
                    ) : (
                        <motion.div
                            className="space-y-6"
                            initial="hidden"
                            animate="visible"
                            variants={{
                                visible: {transition: {staggerChildren: 0.1}},
                            }}
                        >
                            {cartItems.map((item) => (
                                <div key={item.product_id}>
                                    <div className="flex items-center space-x-4">
                                        <Image
                                            src={getImageSrc(item) || "/placeholder.svg"}
                                            alt={item.product_name}
                                            width={80}
                                            height={80}
                                            className="rounded-md"
                                            onError={() => handleImageError(item.product_id)}
                                        />
                                        <div>
                                            <h2 className="text-sm font-sdemibold text-neon-pink">{item.product_name}</h2>
                                            <p className="text-neon-green">{item.price.toLocaleString()}đ</p>
                                            <div className="flex items-center space-x-4 mt-2">
                                                <span className="text-white">{item.quantity}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex flex-col items-end space-y-2">
                                        <p className="text-lg text-neon-yellow">{(item.price * item.quantity).toLocaleString()}đ</p>
                                    </div>
                                </div>
                            ))}

                        </motion.div>
                    )}
                    <motion.div
                        className="flex justify-between items-center mt-8 pt-4 border-t border-gray-700"
                        initial={{opacity: 0}}
                        animate={{opacity: 1}}
                        transition={{duration: 0.5, delay: 0.5}}
                    >
                        <h3 className="text-xl font-bold text-neon-blue">Total:</h3>
                        <p className="text-xl font-bold text-neon-green">{totalPrice.toLocaleString()}đ</p>
                    </motion.div>
                    <motion.div
                        className="flex justify-between items-center mt-8 pt-4 border-t border-gray-700"
                        initial={{opacity: 0}}
                        animate={{opacity: 1}}
                        transition={{duration: 0.5, delay: 0.5}}
                    >
                        <h3 className="text-xl font-bold text-neon-blue">Delivery Price:</h3>
                        <p className="text-xl font-bold text-neon-green">30000đ</p>
                    </motion.div>
                    <motion.div
                        className="flex justify-between items-center mt-8 pt-4 border-t border-gray-700"
                        initial={{opacity: 0}}
                        animate={{opacity: 1}}
                        transition={{duration: 0.5, delay: 0.5}}
                    >
                        <h3 className="text-2xl font-bold text-neon-blue">Grand Total:</h3>
                        <p className="text-2xl font-bold text-neon-green">{(totalPrice + 30000).toLocaleString()}đ</p>
                    </motion.div>
                </div>
            </div>

        </main>
    );
};
